<!DOCTYPE HTML>
<html>
<head>
	<title>Data -- DAC IOT SIUC Testing</title>
	<meta name="viewport" content="initial-scale=1, maximum-scale=1">
	<script src="./js/jquery-3.1.1.min.js"></script>
	<script src="./js/chart.js"></script>

	<style type="text/css">
	#light {
		height: 120px;
		width : 120px;
		border-radius: 50%;
		margin: 0 auto;
		display: inline-block;
	}
	.stop {background-color: red;}
	.go {background-color: green;}
	body {
		background-color : black;
		text-align: center;
		color :white;
		font-family: Helvetica;
	}
	p {
		padding: 1em;
		font-weight: bold;
	}
	h2 {
		text-decoration: underline
	}
	.led-red {
		margin: 0 auto;
		background-color: #F00;
		border-radius: 50%;
		box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #441313 0 -1px 9px, #f00 0 2px 12px;
	}

	.led-green {
		margin: 0 auto;
		background-color: #ABFF00;
		border-radius: 50%;
		box-shadow: rgba(0, 0, 0, 0.2) 0 -1px 7px 1px, inset #304701 0 -1px 9px, #89FF00 0 2px 12px;
	}
	</style>
</head>

<body>
	<canvas id="myChart" style="height: 300; width: 70%;"></canvas>
	<!--<p>Add data points manually below.</p>-->
	<!--<form id="addData">
		<div class="form_group"><label for="time">Time: </label><input type="text" name="time" id="time"></div>
		<div class="form_group"><label for="people">Number of people: </label><input type="text" name="people" id="people"></div>
		<div class="form_group"><input type="submit" value="Add"></div>
	</form>-->
	<label for="values">Data: </label><textarea id="values"></textarea>

	<!--<h1>DAC IOT</h1>-->
	
	<!--<div id="light" class="go"></div>
	<div class="led-box">
		<div id="light" class="led-green"></div>
	</div>

	<h2>Room Traffic Analytics</h2>

	<p>Traffic since page load: <span id="traffic"></span> people</p>
	<p>Average traffic per hour since page load: <span id="avgTraffic"></span> people/hour</p>-->

	<script type="text/javascript">
			var ctx = document.getElementById("myChart").getContext("2d");
		var scatterChart = new Chart(ctx, {
			type: 'line',
			data: {
				datasets: [{
					label: 'Number of people vs Time',
					fill: true,
					backgroundColor: 'rgba(255,0,0,.8)',
					borderColor: 'rgba(0,0,0,1)',
					data: [{
						x: 0,
						y: 0
					}]
				}]
			},
			options: {
				tooltips: {
					callbacks: {
						label: function(tooltipItem, data) {
								return 'Number of people: ' + tooltipItem.yLabel;
						},
						title: function(tooltipItem, data) {
						   return 'Time: ' + tooltipItem[0].xLabel;
						}
					}
				},
				scales: {
					xAxes: [{
						type: 'linear',
						position: 'bottom',
						ticks: {
							max: numTimes,
							min: 0
						},
						scaleLabel: {
							display: true,
							labelString: 'Time'
						}
					}],
					yAxes: [{
						ticks: {
							min: 0
						},
						scaleLabel: {
							display: true,
							labelString: 'Number of people'
						}
					}]
				}
			}
		});
		
		var numTimes = 200;
		var dataSet = scatterChart.data.datasets[0];
		var textArea = document.getElementById('values');
		
		/*document.getElementById("addData").addEventListener("submit", function(e) {
			e.preventDefault();
			appendData(document.getElementById('time').value, document.getElementById('people').value);
		});*/
		
		function appendData(datax,datay) { // time, people
				scatterChart.data.datasets[0].data.push({x:datax,y:datay});
				scatterChart.update();
				updateTextArea();
		}
		function updateTextArea() {
			textArea.innerHTML = "";
			for(var i=0; i < dataSet.data.length; i++ ) {
				textArea.innerHTML += dataSet.data[i].x + "," + dataSet.data[i].y + "\n";
			}
		}
		var startTime = new Date();
		
		setInterval(function() {
			//make the AJAX call
			$.ajax({
					url: '/update-people-chart',
					type: 'POST',
					success: function(data) {
					  updateNumbers(data);
					},
				});
		}, 2000);
		var light = document.getElementById("light");


		function switchLight(color) {
			if (!color.length) {
				$("#light").toggleClass("led-red led-green");
			}
			else {
				light.classList.remove(color == "green" ? "led-red" : "led-green");
				light.classList.add("led-" + color);
			}
		}
		var lastData = {};
		var counter = 0;
		function updateNumbers(data) {
			var endTime = new Date();
			var hours = (endTime - startTime)/3600000;
			var streamBroken = data.streamBroken;
			
			console.log('x' + data.x);
			console.log('y' + data.y);
			
			// is this data new?
			var isNewData = ( lastData == data ? false : true );
			
			if (isNewData) {
				
				appendData(++counter, data.y);
				
	
				// document.getElementById('traffic').value = data.y;
				// document.getElementById('avgTraffic').value = Math.round(data.y/hours);
/*
				if (streamBroken && light.classList.contains("led-green")) {
					appendData(JSON.parse(data.x), data.y);
					switchLight("red");
				}
				else if (!streamBroken && light.classList.contains("led-red")) {
					appendData(data.x, data.y);
					switchLight("green");
				}		*/
				
				
				
				
				
			}
			// Note: nothing is done if light is green and stream isn't 				// broken or if light is red and stream is broken.
		}
	</script>
</body>
</html>
